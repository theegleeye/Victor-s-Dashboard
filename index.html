<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Victor's Personal Dashboard — Modern</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --muted:#94a3b8;
      --accent:#6ee7b7;
      --accent-2:#60a5fa;
      --glass: rgba(255,255,255,0.03);
      --danger:#fb7185;
      --radius:12px;
      --glass-2: rgba(255,255,255,0.02);
    }
    *{box-sizing:border-box}
    html,body{hheight:100%;
      margin:0;
      padding:0;}
    body{
      margin:0;
      font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background:linear-gradient(180deg,#071127 0%, #071b2a 100%);
      color:#e6eef8;
      -webkit-font-smoothing:antialiased;
      padding:28px;
      -webkit-font-smoothing:antialiased;
      position: relative; /* Added for pseudo-element positioning */
    }

    /* Modified vertical accent border - now spans full viewport height */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh; /* Full viewport height */
      width: 4px;
      background-color: var(--accent);
      z-index: 1000;
    }

    .container{
      max-width:1200px;
      margin:0 auto;
      display:grid;
      grid-template-columns:260px 1fr;
      gap:20px;
      align-items:start;
      position: relative; /* Ensure content stays above the border */
      z-index: 1;
    }

    /* Sidebar */
    .sidebar{
      background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      border-radius:var(--radius);
      padding:18px;
      min-height:640px;
      box-shadow: 0 6px 24px rgba(2,6,23,0.6);
      border: 1px solid rgba(255,255,255,0.03);
    }
    .logo{
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom:18px;
    }
    .logo .avatar{
      width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));
      display:flex;align-items:center;justify-content:center;font-weight:700;color:#04263b;
    }
    .nav{display:flex;flex-direction:column;gap:8px}
    .nav button{
      background:transparent;border:0;padding:10px 12px;border-radius:10px;color:var(--muted);text-align:left;cursor:pointer;font-weight:600;
    }
    .nav button.active{
      color:#04263b;background:linear-gradient(90deg,var(--accent),var(--accent-2));box-shadow:0 6px 18px rgba(96,165,250,0.08);
    }

    /* Main */
    .main{
      min-height:640px;
    }
    .header{
      display:flex;
      justify-content:space-between;
      gap:12px;
      margin-bottom:18px;
      align-items:center;
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:14px;padding:18px;border:1px solid rgba(255,255,255,0.03);
      box-shadow: 0 6px 30px rgba(2,6,23,0.6);
    }
    .title{font-weight:700;font-size:18px;color:#e6eef8}
    .subtitle{color:var(--muted);font-size:13px}

    /* Layouts */
    .overview-grid{
      display:grid;
      grid-template-columns: 300px 1fr;
      gap:16px;
      margin-top:12px;
    }
    
    .overview-left {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .overview-right {
      display: grid;
      grid-template-rows: auto auto;
      gap: 16px;
    }
    
    .overview-top {
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 16px;
    }
    
    .overview-bottom {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    .kpi { padding:14px; display:flex;flex-direction:column; gap:8px; }
    .widget-big { padding:14px; min-height:220px; }
    .widget-side { padding:14px; min-height:220px; display:flex;flex-direction:column; gap:12px; }
    .widget-wide { grid-column: 1 / -1; padding:14px; }

    .kpi .kpi-value{ font-size:20px; font-weight:800; }
    .kpi .kpi-label{ color:var(--muted); font-size:13px; }

    /* Chart containers */
    .mini-chart-container {
      position: relative;
      height: 140px;
      width: 100%;
    }
    .small-chart-container {
      position: relative;
      height: 140px;
      width: 100%;
    }

    /* Responsive sections for mobile */
    @media (max-width:1100px){
      .overview-grid{ 
        grid-template-columns: 1fr;
      }
      .overview-left, .overview-right {
        width: 100%;
      }
      .overview-top {
        grid-template-columns: 1fr;
      }
    }
    @media (max-width:700px){
      .container{grid-template-columns:1fr; padding:18px}
      .sidebar{order:2}
      .overview-grid{ grid-template-columns: 1fr; }
      
      /* Adjust border for mobile */
      body::before {
        width: 3px; /* Slightly thinner on mobile */
        height: 100vh; /* Maintain full viewport height */
      }
    }

    .table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      margin-top:12px;
    }
    .table thead td{ color:var(--muted); padding:10px 8px; font-weight:700; font-size:12px; }
    .table tbody td{ padding:12px 8px; border-top:1px solid rgba(255,255,255,0.02); }
    .pill{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.03);color:var(--muted);font-weight:700;font-size:13px}
    .btn{ padding:8px 12px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#04263b;font-weight:700;cursor:pointer; box-shadow:0 6px 18px rgba(96,165,250,0.06);}
    .btn.ghost{ background:transparent;border:1px solid rgba(255,255,255,0.04); color:var(--muted); }

    .muted{ color:var(--muted); }

    .flex-row{display:flex;gap:10px;align-items:center;}
    .card-header{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:8px; }

    /* small badges */
    .badge { font-size:12px; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,0.03); color:var(--muted); font-weight:700; }

    /* quick stat row */
    .stat-row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }

    /* helper for positive/negative */
    .pos{ color:var(--accent-2); font-weight:800; }
    .neg{ color:var(--danger); font-weight:800; }

    /* Empty state styles */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      text-align: center;
      color: var(--muted);
      font-size: 14px;
    }
    .empty-state-icon {
      font-size: 24px;
      margin-bottom: 10px;
    }

  </style>
</head>
<body>
  <div class="container">
    <aside class="sidebar card">
      <div class="logo">
        <div class="avatar">V</div>
        <div>
          <div style="font-weight:800">Victor</div>
          <div style="font-size:13px;color:var(--muted)">Personal Dashboard</div>
        </div>
      </div>

      <nav class="nav" id="mainNav">
        <button data-tab="overview" class="active">Overview</button>
        <button data-tab="trades">Trades</button>
        <button data-tab="gym">Gym</button>
        <button data-tab="tasks">Tasks</button>
        <button data-tab="habits">Habits</button>
        <button data-tab="savings">Savings</button>
      </nav>
    </aside>

    <main class="main">
      <div class="header">
        <div>
          <div class="title">Dashboard</div>
          <div class="subtitle">Insights and trackers — modern & focused</div>
        </div>

        <div style="display:flex;gap:10px;align-items:center">
          <div class="pill">UTC</div>
          <button class="btn" id="addQuick">Add Quick</button>
        </div>
      </div>

      <section id="contentArea">

        <!-- OVERVIEW -->
        <div id="overview" class="card" style="display:block;">
          <div class="card-header">
            <div>
              <div class="title">Overview</div>
              <div class="subtitle">Quick glance at your trackers</div>
            </div>
            <div class="stat-row">
              <div class="badge" id="overviewLastUpdated">Last updated: —</div>
              <div class="badge" id="overviewSource">Source: Local</div>
            </div>
          </div>

          <div class="overview-grid">
            <div class="overview-left">
              <!-- KPI cards -->
              <div class="card kpi">
                <div class="muted">Total Balance</div>
                <div class="kpi-value" id="kpiTotalBalance">NLE0.00</div>
                <div class="muted" style="font-size:12px">Combined across savings and trades</div>
              </div>

              <div class="card kpi">
                <div class="muted">Weekly Net</div>
                <div class="kpi-value" id="kpiWeeklyNet">NLE0.00</div>
                <div class="muted" style="font-size:12px">This week's income - expenses</div>
              </div>

              <div class="card kpi">
                <div class="muted">Active Streak</div>
                <div class="kpi-value" id="kpiStreak">0 days</div>
                <div class="muted" style="font-size:12px">Longest habit streak</div>
              </div>
              
              <!-- Habit Streak chart -->
              <div class="card widget-side">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div><div style="font-weight:700">Habit Streak</div><div class="muted" style="font-size:13px">Daily performance</div></div>
                  <div class="muted">Streaks</div>
                </div>
                <div class="small-chart-container">
                  <canvas id="streaksChart"></canvas>
                </div>
              </div>
            </div>
            
            <div class="overview-right">
              <div class="overview-top">
                <!-- Line chart (trends over time) -->
                <div class="card widget-big">
                  <div style="display:flex;justify-content:space-between;align-items:center">
                    <div><div style="font-weight:700">Balance Trend</div><div class="muted" style="font-size:13px">Last 12 points</div></div>
                    <div class="muted" style="font-size:13px">Auto-updates</div>
                  </div>
                  <div class="mini-chart-container">
                    <canvas id="balanceTrend"></canvas>
                  </div>
                </div>

                <!-- Pie + tabbed mini-summary -->
                <div class="card widget-side">
                  <div style="display:flex;justify-content:space-between;align-items:center">
                    <div><div style="font-weight:700" id="allocationTitle">Allocation</div><div class="muted" style="font-size:13px">Savings vs Expenses vs Trades</div></div>
                    <div class="muted" style="font-size:13px">Overview</div>
                  </div>
                  <div class="small-chart-container">
                    <canvas id="allocationPie"></canvas>
                  </div>

                  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
                    <button class="btn ghost active" id="overviewTabAll">All</button>
                    <button class="btn ghost" id="overviewTabFinance">Finance</button>
                    <button class="btn ghost" id="overviewTabHealth">Health</button>
                  </div>
                </div>
              </div>
              
              <div class="overview-bottom">
                <!-- Small widgets for each tracker -->
                <div class="card widget-wide" style="min-height:160px;">
                  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                    <div><div style="font-weight:700">Trackers snapshot</div><div class="muted" style="font-size:13px">Quick metrics from each tab</div></div>
                    <div class="muted" id="snapUpdated">—</div>
                  </div>

                  <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
                    <div class="card" style="padding:12px;background:var(--glass);border-radius:10px;">
                      <div class="muted">Trades P/L</div>
                      <div style="font-weight:800" id="snapTrades">—</div>
                    </div>
                    <div class="card" style="padding:12px;background:var(--glass);border-radius:10px;">
                      <div class="muted">Gym Sessions</div>
                      <div style="font-weight:800" id="snapGym">—</div>
                    </div>
                    <div class="card" style="padding:12px;background:var(--glass);border-radius:10px;">
                      <div class="muted">Open Tasks</div>
                      <div style="font-weight:800" id="snapTasks">—</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- TRADES -->
        <div id="trades" class="card" style="display:none;margin-top:14px;">
          <div class="card-header">
            <div>
              <div class="title">Trades</div>
              <div class="subtitle">Forex / Equity trades — log trades to populate insights</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="btn" id="addTradeBtn">Add Trade</button>
              <button class="btn ghost" id="exportTrades">Export</button>
              <button class="btn ghost" id="importTrades">Import</button>
            </div>
          </div>

          <div style="display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap">
            <div style="flex:1; min-width:320px" class="card">
              <div style="font-weight:700">Recent Trades</div>
              <table class="table" id="tradesTable">
                <thead>
                  <tr><td>Pair</td><td>Type</td><td>Size</td><td>PL</td><td>Date</td><td>Actions</td></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div style="width:300px" class="card">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div style="font-weight:700">Trades Summary</div>
                <div class="muted" id="tradesSummaryDate">—</div>
              </div>
              <div style="margin-top:12px">
                <div class="muted">Net P/L</div>
                <div style="font-weight:800;font-size:18px" id="tradesNet">—</div>
              </div>

              <div style="margin-top:12px">
                <canvas id="tradesPerf" style="height:160px;width:100%"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- GYM -->
        <div id="gym" class="card" style="display:none;margin-top:14px;">
          <div class="card-header">
            <div>
              <div class="title">Gym</div>
              <div class="subtitle">Workout history & insights</div>
            </div>
            <div><button class="btn" id="addWorkout">Add Workout</button></div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 300px;gap:12px;align-items:start">
            <div class="card">
              <div style="font-weight:700">Workouts</div>
              <table class="table" id="gymTable">
                <thead>
                  <tr><td>Date</td><td>Type</td><td>Duration</td><td>Notes</td><td>Actions</td></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="card">
              <div style="font-weight:700">Progress</div>
              <div style="margin-top:12px"><canvas id="gymChart" style="height:200px;width:100%"></canvas></div>
            </div>
          </div>
        </div>

        <!-- TASKS -->
        <div id="tasks" class="card" style="display:none;margin-top:14px;">
          <div class="card-header">
            <div>
              <div class="title">Tasks</div>
              <div class="subtitle">Internship & daily tasks</div>
            </div>
            <div style="display:flex;gap:8px">
              <input id="newTaskInput" placeholder="New task..." style="padding:10px;border-radius:8px;background:#071528;border:1px solid rgba(255,255,255,0.03);color:#e6eef8;outline:none">
              <button class="btn" id="addTaskBtn">Add</button>
            </div>
          </div>

          <div class="card">
            <table class="table" id="tasksTable">
              <thead><tr><td>Task</td><td>Status</td><td>Due</td><td></td></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- HABITS -->
        <div id="habits" class="card" style="display:none;margin-top:14px;">
          <div class="card-header">
            <div>
              <div class="title">Habits</div>
              <div class="subtitle">Habit tracking & streaks</div>
            </div>
            <div><button class="btn" id="addHabit">New Habit</button></div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 300px;gap:12px">
            <div class="card">
              <div style="font-weight:700">Habits</div>
              <table class="table" id="habitsTable">
                <thead><tr><td>Habit</td><td>Streak</td><td>Last</td><td></td></tr></thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="card">
              <div style="font-weight:700">Weekly view</div>
              <div style="margin-top:12px"><canvas id="habitWeek" style="height:200px;width:100%"></canvas></div>
            </div>
          </div>
        </div>

        <!-- SAVINGS -->
        <div id="savings" class="card" style="display:none;margin-top:14px;">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
            <div>
              <div class="title">Savings</div>
              <div class="subtitle">Track weekly & monthly savings, add expenses, and view totals</div>
            </div>
            <div class="summary" style="text-align:right">
              <div class="muted">Total Balance</div>
              <div id="totalBalance" class="kpi-value">NLE0.00</div>
              <div style="font-size:13px;color:var(--muted)">Combined savings minus expenses</div>
            </div>
          </div>

          <hr style="opacity:0.04;margin:14px 0;border:none;height:1px;background:rgba(255,255,255,0.03)">

          <div class="grid-2" style="display:grid;grid-template-columns:1fr 320px;gap:18px">
            <div>
              <div class="savings-tabs" role="tablist" style="display:flex;gap:8px;margin-bottom:12px">
                <button data-view="weekly" class="active">Weekly</button>
                <button data-view="monthly">Monthly</button>
              </div>

              <div class="card" style="margin-top:8px;">
                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                  <input id="itemName" class="input" placeholder="Expense name (e.g., Groceries)" style="flex:1;padding:10px;border-radius:8px;background:#071528;border:1px solid rgba(255,255,255,0.03);color:#e6eef8">
                  <input id="itemAmount" class="input" placeholder="Amount" type="number" step="0.01" style="width:140px;padding:10px;border-radius:8px;background:#071528;border:1px solid rgba(255,255,255,0.03);color:#e6eef8">
                  <select id="itemType" class="select" style="padding:10px;border-radius:8px;background:#071528;border:1px solid rgba(255,255,255,0.03);color:#e6eef8">
                    <option value="expense">Expense</option>
                    <option value="saving">Saving</option>
                  </select>
                  <button id="addItem" class="btn">Add</button>
                </div>

                <div style="display:flex;gap:8px;margin-top:12px;align-items:center;flex-wrap:wrap">
                  <input id="filterSearch" class="input" placeholder="Search..." style="flex:1;padding:10px;border-radius:8px;background:#071528;border:1px solid rgba(255,255,255,0.03);color:#e6eef8">
                  <button id="clearAll" class="btn ghost">Clear All</button>
                  <button id="exportSavings" class="btn ghost">Export</button>
                  <button id="importSavings" class="btn ghost">Import</button>
                </div>

                <div class="list" id="itemsList" style="margin-top:12px"></div>
              </div>
            </div>

            <aside>
              <div class="card">
                <div class="title">Summary</div>
                <div class="subtitle">Breakdown for current view</div>

                <div style="display:flex;justify-content:space-between;margin-top:12px">
                  <div>
                    <div class="muted">Total Savings</div>
                    <div id="viewSavings" class="kpi-value">NLE0.00</div>
                    <div class="muted" style="margin-top:6px">Amount you've set aside</div>
                  </div>

                  <div>
                    <div class="muted">Total Expenses</div>
                    <div id="viewExpenses" class="kpi-value neg">NLE0.00</div>
                    <div class="muted" style="margin-top:6px">Money spent</div>
                  </div>
                </div>

                <hr style="opacity:0.04;margin:12px 0;border:none;height:1px;background:rgba(255,255,255,0.03)">

                <div style="display:flex;gap:8px;flex-direction:column">
                  <div style="display:flex;justify-content:space-between">
                    <div class="muted">Net (view)</div>
                    <div id="viewNet" class="kpi-value">NLE0.00</div>
                  </div>
                  <div style="display:flex;justify-content:space-between;margin-top:6px">
                    <div class="muted">Combined Totals</div>
                    <div id="combinedTotals" class="kpi-value">NLE0.00</div>
                  </div>
                </div>

                <div style="margin-top:12px;font-size:13px;color:var(--muted)">
                  Tip: switch between Weekly and Monthly to manage short and long-term savings.
                </div>
              </div>
            </aside>
          </div>
        </div>

      </section>
    </main>
  </div>

  <script>
    /* ---------------------------
       Data Storage Setup
    ----------------------------*/
    const STORAGE_KEYS = {
      TRADES: 'dashboard_trades_v1',
      GYM: 'dashboard_gym_v1',
      TASKS: 'dashboard_tasks_v1',
      HABITS: 'dashboard_habits_v1',
      SAVINGS: 'dashboard_savings_v1'
    };

    // Initialize empty data structures
    let tradesData = [];
    let gymData = [];
    let tasksData = [];
    let habitsData = [];
    let savingsData = { weekly: [], monthly: [] };

    // Track current allocation view
    let currentAllocationView = 'all';

    /* ---------------------------
       Storage Helper Functions
    ----------------------------*/
    function loadData() {
      try {
        // Load trades data
        const tradesRaw = localStorage.getItem(STORAGE_KEYS.TRADES);
        if (tradesRaw) tradesData = JSON.parse(tradesRaw);
        
        // Load gym data
        const gymRaw = localStorage.getItem(STORAGE_KEYS.GYM);
        if (gymRaw) gymData = JSON.parse(gymRaw);
        
        // Load tasks data
        const tasksRaw = localStorage.getItem(STORAGE_KEYS.TASKS);
        if (tasksRaw) tasksData = JSON.parse(tasksRaw);
        
        // Load habits data
        const habitsRaw = localStorage.getItem(STORAGE_KEYS.HABITS);
        if (habitsRaw) habitsData = JSON.parse(habitsRaw);
        
        // Load savings data
        const savingsRaw = localStorage.getItem(STORAGE_KEYS.SAVINGS);
        if (savingsRaw) savingsData = JSON.parse(savingsRaw);
        
        // Ensure savings has both weekly and monthly arrays
        if (!savingsData.weekly) savingsData.weekly = [];
        if (!savingsData.monthly) savingsData.monthly = [];
      } catch (e) {
        console.error('Error loading data from localStorage:', e);
      }
    }

    function saveData(key, data) {
      try {
        localStorage.setItem(key, JSON.stringify(data));
      } catch (e) {
        console.error('Error saving data to localStorage:', e);
      }
    }

    function exportData(key, defaultFileName) {
      const data = localStorage.getItem(key);
      if (!data) {
        alert('No data to export');
        return;
      }
      
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = defaultFileName || `${key}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importData(key, callback) {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      
      input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = event => {
          try {
            const data = JSON.parse(event.target.result);
            callback(data);
          } catch (err) {
            alert('Invalid file format');
            console.error('Error parsing imported file:', err);
          }
        };
        reader.readAsText(file);
      };
      
      input.click();
    }

    /* ---------------------------
       Shared: Tab handling
    ----------------------------*/
    const navButtons = document.querySelectorAll('#mainNav button');
    const sections = ['overview','trades','gym','tasks','habits','savings'];
    navButtons.forEach(btn=>{
      btn.addEventListener('click',()=>{
        navButtons.forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const tab = btn.getAttribute('data-tab');
        sections.forEach(id=>{
          const el = document.getElementById(id);
          if(!el) return;
          el.style.display = (id === tab ? 'block' : 'none');
        });
        if(tab === 'savings') {
          renderList();
          updateAllSummaries();
        }
      });
    });

    /* ---------------------------
       Savings Tab
    ----------------------------*/
    // UI elements
    const viewButtons = document.querySelectorAll('.savings-tabs button');
    let currentView = 'weekly';
    viewButtons.forEach(b=>{
      b.addEventListener('click',()=>{
        viewButtons.forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        currentView = b.getAttribute('data-view');
        renderList();
        updateAllSummaries();
      });
    });

    const addBtn = document.getElementById('addItem');
    const nameIn = document.getElementById('itemName');
    const amountIn = document.getElementById('itemAmount');
    const typeIn = document.getElementById('itemType');
    const itemsList = document.getElementById('itemsList');
    const filterSearch = document.getElementById('filterSearch');
    const clearAllBtn = document.getElementById('clearAll');
    const exportSavingsBtn = document.getElementById('exportSavings');
    const importSavingsBtn = document.getElementById('importSavings');

    addBtn.addEventListener('click', ()=>{
      const name = nameIn.value.trim();
      const amount = parseFloat(amountIn.value);
      const type = typeIn.value;
      if(!name || isNaN(amount)){ alert('Please provide a name and valid amount'); return; }
      const item = { id: Date.now().toString(36), name, amount: Math.round(amount*100)/100, type, created: new Date().toISOString() };
      savingsData[currentView].unshift(item);
      saveData(STORAGE_KEYS.SAVINGS, savingsData);
      nameIn.value = ''; amountIn.value = '';
      renderList();
      updateAllSummaries();
      updateAllCharts();
    });

    filterSearch.addEventListener('input', renderList);
    
    clearAllBtn.addEventListener('click', ()=>{
      if(!confirm('Clear all entries for ' + currentView + '?')) return;
      savingsData[currentView] = [];
      saveData(STORAGE_KEYS.SAVINGS, savingsData);
      renderList();
      updateAllSummaries();
      updateAllCharts();
    });
    
    exportSavingsBtn.addEventListener('click', () => {
      exportData(STORAGE_KEYS.SAVINGS, 'savings-export.json');
    });
    
    importSavingsBtn.addEventListener('click', () => {
      importData(STORAGE_KEYS.SAVINGS, (data) => {
        if (!data.weekly || !data.monthly) {
          alert('Invalid savings data format');
          return;
        }
        savingsData = data;
        saveData(STORAGE_KEYS.SAVINGS, savingsData);
        renderList();
        updateAllSummaries();
        updateAllCharts();
      });
    });

    function renderList(){
      const list = savingsData[currentView] || [];
      const q = filterSearch.value.trim().toLowerCase();
      itemsList.innerHTML = '';
      const filtered = list.filter(i => i.name.toLowerCase().includes(q));
      
      if(filtered.length === 0){
        const empty = document.createElement('div');
        empty.className = 'empty-state';
        empty.innerHTML = `
          <div class="empty-state-icon">📊</div>
          <div>No ${currentView} entries found</div>
          <div style="font-size:12px;margin-top:8px">Add your first saving or expense</div>
        `;
        itemsList.appendChild(empty);
        return;
      }
      
      filtered.forEach(item=>{
        const el = document.createElement('div');
        el.className = 'item';
        el.style.display = 'flex';
        el.style.justifyContent = 'space-between';
        el.style.gap = '12px';
        el.style.alignItems = 'center';
        el.style.padding = '10px';
        el.style.borderRadius = '10px';
        el.style.background = 'linear-gradient(180deg, rgba(255,255,255,0.01), transparent)';
        el.innerHTML = `
          <div class="meta" style="display:flex;gap:12px;align-items:center">
            <div style="display:flex;flex-direction:column">
              <div style="font-weight:700">${escapeHtml(item.name)}</div>
              <div class="muted" style="font-size:12px">${new Date(item.created).toLocaleString()}</div>
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:10px">
            <div class="amount ${item.type === 'expense' ? 'neg' : 'pos'}">${item.type === 'expense' ? '-' : '+'}NLE${Number(item.amount).toFixed(2)}</div>
            <div style="display:flex;gap:6px">
              <button class="btn ghost" data-id="${item.id}" data-action="edit">Edit</button>
              <button class="btn ghost" data-id="${item.id}" data-action="delete">Delete</button>
            </div>
          </div>`;
        const deleteBtn = el.querySelector('button[data-action="delete"]');
        deleteBtn.addEventListener('click', ()=>{ removeItem(item.id); updateAllCharts(); });
        const editBtn = el.querySelector('button[data-action="edit"]');
        editBtn.addEventListener('click', ()=>{ openEdit(item); updateAllCharts(); });
        itemsList.appendChild(el);
      });
    }

    function removeItem(id){
      savingsData[currentView] = savingsData[currentView].filter(i => i.id !== id);
      saveData(STORAGE_KEYS.SAVINGS, savingsData);
      renderList();
      updateAllSummaries();
    }

    function openEdit(item){
      const newName = prompt('Edit name', item.name);
      if(newName === null) return;
      const newAmountRaw = prompt('Edit amount', item.amount);
      if(newAmountRaw === null) return;
      const newAmount = parseFloat(newAmountRaw);
      if(newName.trim() === '' || isNaN(newAmount)){ alert('Invalid inputs'); return; }
      const list = savingsData[currentView];
      const idx = list.findIndex(i => i.id === item.id);
      if(idx >= 0){
        list[idx].name = newName.trim();
        list[idx].amount = Math.round(newAmount*100)/100;
        saveData(STORAGE_KEYS.SAVINGS, savingsData);
        renderList();
        updateAllSummaries();
      }
    }

    function calcTotalsFor(list){
      let savings = 0;
      let expenses = 0;
      (list || []).forEach(i=>{
        if(i.type === 'saving') savings += Number(i.amount);
        else expenses -= Number(i.amount); // expenses negative
      });
      return { savings: Math.round(savings*100)/100, expenses: Math.round(expenses*100)/100 };
    }

    function formatMoney(n, currency = 'NLE'){
      const sign = n < 0 ? '-' : '';
      const val = Math.abs(n).toFixed(2);
      // Use $ for trades, NLE for everything else
      const symbol = currency === '$' ? '$' : 'NLE';
      return `${sign}${symbol}${Number(val).toLocaleString()}`;
    }

    function escapeHtml(s){ return (s+'').replace(/[&<>\"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }

    function updateAllSummaries(){
      const weekly = savingsData.weekly || [];
      const monthly = savingsData.monthly || [];
      const totals = calcTotalsFor(weekly);
      const totalsMonthly = calcTotalsFor(monthly);
      const viewTotals = currentView === 'weekly' ? totals : totalsMonthly;
      document.getElementById('viewSavings').textContent = formatMoney(viewTotals.savings);
      document.getElementById('viewExpenses').textContent = formatMoney(viewTotals.expenses * -1);
      const netView = viewTotals.savings + viewTotals.expenses;
      document.getElementById('viewNet').textContent = formatMoney(netView);
      const combined = { savings: totals.savings + totalsMonthly.savings, expenses: totals.expenses + totalsMonthly.expenses };
      document.getElementById('combinedTotals').textContent = formatMoney(combined.savings + combined.expenses);
      document.getElementById('totalBalance').textContent = formatMoney(combined.savings + combined.expenses);

      // Update KPI
      document.getElementById('kpiTotalBalance').textContent = formatMoney(combined.savings + combined.expenses);
      document.getElementById('kpiWeeklyNet').textContent = formatMoney(totals.savings + totals.expenses);
      // small summary
      document.getElementById('snapUpdated').textContent = new Date().toLocaleString();
    }

    /* ---------------------------
       Trades Tab
    ----------------------------*/
    const tradesTable = document.getElementById('tradesTable').querySelector('tbody');
    const addTradeBtn = document.getElementById('addTradeBtn');
    const exportTradesBtn = document.getElementById('exportTrades');
    const importTradesBtn = document.getElementById('importTrades');

    function renderTrades() {
      tradesTable.innerHTML = '';
      
      if (tradesData.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="6" class="empty-state">
            <div class="empty-state-icon">💹</div>
            <div>No trades recorded yet</div>
            <div style="font-size:12px;margin-top:8px">Add your first trade to see data here</div>
          </td>
        `;
        tradesTable.appendChild(row);
        return;
      }
      
      tradesData.forEach(trade => {
        const row = document.createElement('tr');
        const plClass = trade.pl >= 0 ? 'pos' : 'neg';
        row.innerHTML = `
          <td>${trade.pair}</td>
          <td><span class="pill">${trade.type}</span></td>
          <td>${trade.size}</td>
          <td class="${plClass}">${trade.pl >= 0 ? '+' : ''}${trade.pl.toFixed(2)}</td>
          <td>${trade.date}</td>
          <td style="display:flex;gap:6px">
            <button class="btn ghost" data-id="${trade.id}">Edit</button>
            <button class="btn ghost" data-id="${trade.id}" data-action="delete">Delete</button>
          </td>
        `;
        row.querySelector('button').addEventListener('click', () => editTrade(trade.id));
        row.querySelector('[data-action="delete"]').addEventListener('click', () => deleteTrade(trade.id));
        tradesTable.appendChild(row);
      });
      
      // Update summary - use $ for trades
      const netPL = tradesData.reduce((sum, t) => sum + t.pl, 0);
      document.getElementById('tradesNet').textContent = `${netPL >= 0 ? '+' : ''}${netPL.toFixed(2)}`;
      document.getElementById('tradesSummaryDate').textContent = new Date().toLocaleDateString();
      
      // Update KPI - use $ for trades
      document.getElementById('snapTrades').textContent = `${netPL >= 0 ? '+' : ''}${netPL.toFixed(2)}`;
      
      // Update charts
      updateTradesChart();
    }

    function editTrade(id) {
      const trade = tradesData.find(t => t.id === id);
      if (!trade) return;
      
      const newPL = parseFloat(prompt('Edit P/L', trade.pl));
      if (isNaN(newPL)) return;
      
      trade.pl = newPL;
      saveData(STORAGE_KEYS.TRADES, tradesData);
      renderTrades();
      updateAllCharts();
    }

    function deleteTrade(id) {
      if (!confirm('Are you sure you want to delete this trade?')) return;
      tradesData = tradesData.filter(t => t.id !== id);
      saveData(STORAGE_KEYS.TRADES, tradesData);
      renderTrades();
      updateAllCharts();
    }

    addTradeBtn.addEventListener('click', () => {
      const pair = prompt('Currency pair (e.g. EUR/USD)');
      if (!pair) return;
      
      const type = prompt('Type (Long/Short)', 'Long');
      if (!type) return;
      
      const size = parseFloat(prompt('Size (lot size)', '0.1'));
      if (isNaN(size)) return;
      
      const pl = parseFloat(prompt('Profit/Loss', '0'));
      if (isNaN(pl)) return;
      
      const newTrade = {
        id: 't' + Date.now().toString(36),
        pair,
        type,
        size: size.toFixed(2),
        pl,
        date: new Date().toISOString().split('T')[0]
      };
      
      tradesData.unshift(newTrade);
      saveData(STORAGE_KEYS.TRADES, tradesData);
      renderTrades();
      updateAllCharts();
    });

    exportTradesBtn.addEventListener('click', () => {
      exportData(STORAGE_KEYS.TRADES, 'trades-export.json');
    });
    
    importTradesBtn.addEventListener('click', () => {
      importData(STORAGE_KEYS.TRADES, (data) => {
        if (!Array.isArray(data)) {
          alert('Invalid trades data format');
          return;
        }
        tradesData = data;
        saveData(STORAGE_KEYS.TRADES, tradesData);
        renderTrades();
        updateAllCharts();
      });
    });

    /* ---------------------------
       Gym Tab
    ----------------------------*/
    const gymTable = document.getElementById('gymTable').querySelector('tbody');
    const addWorkoutBtn = document.getElementById('addWorkout');

    function renderGym() {
      gymTable.innerHTML = '';
      
      if (gymData.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="5" class="empty-state">
            <div class="empty-state-icon">🏋️</div>
            <div>No workouts recorded yet</div>
            <div style="font-size:12px;margin-top:8px">Add your first workout to see data here</div>
          </td>
        `;
        gymTable.appendChild(row);
        return;
      }
      
      gymData.forEach(workout => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${workout.date}</td>
          <td><span class="pill">${workout.type}</span></td>
          <td>${workout.duration} mins</td>
          <td>${workout.notes || '—'}</td>
          <td><button class="btn ghost" data-date="${workout.date}" data-action="delete">Delete</button></td>
        `;
        row.querySelector('[data-action="delete"]').addEventListener('click', () => deleteWorkout(workout.date));
        gymTable.appendChild(row);
      });
      
      // Update KPI
      document.getElementById('snapGym').textContent = gymData.length + ' sessions';
      
      // Update charts
      updateGymChart();
    }

    function deleteWorkout(date) {
      if (!confirm('Are you sure you want to delete this workout?')) return;
      gymData = gymData.filter(w => w.date !== date);
      saveData(STORAGE_KEYS.GYM, gymData);
      renderGym();
      updateAllCharts();
    }

    addWorkoutBtn.addEventListener('click', () => {
      const type = prompt('Workout type (e.g. Cardio, Strength)', 'Cardio');
      if (!type) return;
      
      const duration = parseInt(prompt('Duration (minutes)', '30'));
      if (isNaN(duration)) return;
      
      const notes = prompt('Notes (optional)');
      
      const newWorkout = {
        date: new Date().toISOString().split('T')[0],
        type,
        duration,
        notes: notes || ''
      };
      
      gymData.unshift(newWorkout);
      saveData(STORAGE_KEYS.GYM, gymData);
      renderGym();
      updateAllCharts();
    });

    /* ---------------------------
       Tasks Tab
    ----------------------------*/
    const tasksTable = document.getElementById('tasksTable').querySelector('tbody');
    const addTaskBtn = document.getElementById('addTaskBtn');
    const newTaskInput = document.getElementById('newTaskInput');

    function renderTasks() {
      tasksTable.innerHTML = '';
      
      if (tasksData.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="4" class="empty-state">
            <div class="empty-state-icon">📝</div>
            <div>No tasks recorded yet</div>
            <div style="font-size:12px;margin-top:8px">Add your first task to see data here</div>
          </td>
        `;
        tasksTable.appendChild(row);
        return;
      }
      
      tasksData.forEach(task => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${task.text}</td>
          <td><span class="pill ${task.status === 'done' ? 'pos' : ''}">${task.status}</span></td>
          <td>${task.due}</td>
          <td>
            <button class="btn ghost" data-id="${task.id}" data-action="toggle">Toggle</button>
            <button class="btn ghost" data-id="${task.id}" data-action="delete">Delete</button>
          </td>
        `;
        row.querySelector('[data-action="toggle"]').addEventListener('click', () => toggleTask(task.id));
        row.querySelector('[data-action="delete"]').addEventListener('click', () => deleteTask(task.id));
        tasksTable.appendChild(row);
      });
      
      // Update KPI
      const pendingTasks = tasksData.filter(t => t.status === 'pending').length;
      document.getElementById('snapTasks').textContent = pendingTasks + ' pending';
    }

    function toggleTask(id) {
      const task = tasksData.find(t => t.id === id);
      if (task) {
        task.status = task.status === 'pending' ? 'done' : 'pending';
        saveData(STORAGE_KEYS.TASKS, tasksData);
        renderTasks();
        updateAllCharts();
      }
    }

    function deleteTask(id) {
      tasksData = tasksData.filter(t => t.id !== id);
      saveData(STORAGE_KEYS.TASKS, tasksData);
      renderTasks();
      updateAllCharts();
    }

    addTaskBtn.addEventListener('click', addNewTask);
    newTaskInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') addNewTask();
    });

    function addNewTask() {
      const text = newTaskInput.value.trim();
      if (!text) return;
      
      const newTask = {
        id: 'tsk' + Date.now().toString(36),
        text,
        status: 'pending',
        due: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] // 7 days from now
      };
      
      tasksData.unshift(newTask);
      saveData(STORAGE_KEYS.TASKS, tasksData);
      newTaskInput.value = '';
      renderTasks();
      updateAllCharts();
    }

    /* ---------------------------
       Habits Tab
    ----------------------------*/
    const habitsTable = document.getElementById('habitsTable').querySelector('tbody');
    const addHabitBtn = document.getElementById('addHabit');

    function renderHabits() {
      habitsTable.innerHTML = '';
      
      if (habitsData.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="4" class="empty-state">
            <div class="empty-state-icon">🔁</div>
            <div>No habits tracked yet</div>
            <div style="font-size:12px;margin-top:8px">Add your first habit to see data here</div>
          </td>
        `;
        habitsTable.appendChild(row);
        return;
      }
      
      habitsData.forEach(habit => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${habit.name}</td>
          <td>${habit.streak} days</td>
          <td>${habit.last || 'Never'}</td>
          <td>
            <button class="btn ghost" data-id="${habit.id}" data-action="log">Log</button>
            <button class="btn ghost" data-id="${habit.id}" data-action="delete">Delete</button>
          </td>
        `;
        row.querySelector('[data-action="log"]').addEventListener('click', () => logHabit(habit.id));
        row.querySelector('[data-action="delete"]').addEventListener('click', () => deleteHabit(habit.id));
        habitsTable.appendChild(row);
      });
      
      // Update KPI
      const longestStreak = habitsData.reduce((max, h) => Math.max(max, h.streak), 0);
      document.getElementById('kpiStreak').textContent = longestStreak + ' days';
      
      // Update charts
      updateHabitsChart();
    }

    function logHabit(id) {
      const habit = habitsData.find(h => h.id === id);
      if (!habit) return;
      
      // Simple streak logic: if logged today, don't increase
      const today = new Date().toISOString().split('T')[0];
      if (habit.last === today) return;
      
      // If logged yesterday, increase streak, else reset to 1
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      const yesterdayStr = yesterday.toISOString().split('T')[0];
      
      if (habit.last === yesterdayStr) {
        habit.streak++;
      } else {
        habit.streak = 1;
      }
      
      habit.last = today;
      saveData(STORAGE_KEYS.HABITS, habitsData);
      renderHabits();
      updateAllCharts();
    }

    function deleteHabit(id) {
      habitsData = habitsData.filter(h => h.id !== id);
      saveData(STORAGE_KEYS.HABITS, habitsData);
      renderHabits();
      updateAllCharts();
    }

    addHabitBtn.addEventListener('click', () => {
      const name = prompt('Habit name (e.g. "Meditate daily")');
      if (!name) return;
      
      const newHabit = {
        id: 'h' + Date.now().toString(36),
        name,
        streak: 0,
        last: ''
      };
      
      habitsData.unshift(newHabit);
      saveData(STORAGE_KEYS.HABITS, habitsData);
      renderHabits();
      updateAllCharts();
    });

    /* ---------------------------
       Charts
    ----------------------------*/
    let balanceTrendChart, allocationPieChart, streaksChart, tradesPerfChart, gymChart, habitWeekChart;

    function updateAllCharts() {
      updateBalanceTrend();
      updateAllocationPie();
      updateStreaksChart();
      updateTradesChart();
      updateGymChart();
      updateHabitsChart();
    }

    function getCombinedFinancialHistory() {
      // Get all savings entries (weekly + monthly)
      const allSavings = [...savingsData.weekly, ...savingsData.monthly];
      
      // Group savings by date
      const savingsByDate = {};
      allSavings.forEach(item => {
        const date = item.created.split('T')[0];
        if (!savingsByDate[date]) {
          savingsByDate[date] = { savings: 0, expenses: 0 };
        }
        
        if (item.type === 'saving') {
          savingsByDate[date].savings += item.amount;
        } else {
          savingsByDate[date].expenses += item.amount;
        }
      });
      
      // Group trades by date
      const tradesByDate = {};
      tradesData.forEach(trade => {
        if (!tradesByDate[trade.date]) {
          tradesByDate[trade.date] = 0;
        }
        tradesByDate[trade.date] += trade.pl;
      });
      
      // Combine all unique dates
      const allDates = new Set([
        ...Object.keys(savingsByDate),
        ...Object.keys(tradesByDate)
      ]);
      
      // Sort dates chronologically
      const sortedDates = Array.from(allDates).sort((a, b) => new Date(a) - new Date(b));
      
      // Calculate running balance starting from 0
      let runningBalance = 0;
      const balanceHistory = [];
      
      sortedDates.forEach(date => {
        const savings = savingsByDate[date] || { savings: 0, expenses: 0 };
        const trades = tradesByDate[date] || 0;
        
        runningBalance += savings.savings - savings.expenses + trades;
        balanceHistory.push({
          date,
          balance: runningBalance
        });
      });
      
      // If no data, return empty array
      if (balanceHistory.length === 0) return [];
      
      // Get the last 12 data points (or all if less than 12)
      const startIdx = Math.max(0, balanceHistory.length - 12);
      return balanceHistory.slice(startIdx);
    }

    function updateBalanceTrend() {
      const ctx = document.getElementById('balanceTrend').getContext('2d');
      const history = getCombinedFinancialHistory();
      
      if (history.length === 0) {
        if (balanceTrendChart) balanceTrendChart.destroy();
        return;
      }
      
      const labels = history.map(item => {
        const date = new Date(item.date);
        return date.toLocaleDateString('en', {month: 'short', day: 'numeric'});
      });
      
      const data = history.map(item => item.balance);
      
      if (balanceTrendChart) balanceTrendChart.destroy();
      
      balanceTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Balance',
            data,
            borderColor: 'rgba(110, 231, 183, 1)',
            backgroundColor: 'rgba(110, 231, 183, 0.1)',
            borderWidth: 2,
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: function(context) {
                  return `Balance: NLE${context.raw.toFixed(2)}`;
                }
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { color: 'rgba(148, 163, 184, 0.6)' }
            },
            y: {
              grid: { color: 'rgba(255, 255, 255, 0.03)' },
              ticks: { 
                color: 'rgba(148, 163, 184, 0.6)',
                callback: function(value) {
                  return `NLE${value}`;
                }
              }
            }
          }
        }
      });
    }

    function updateAllocationPie() {
      const ctx = document.getElementById('allocationPie').getContext('2d');
      
      // Calculate allocations based on current view
      let labels = [];
      let data = [];
      let backgroundColor = [];
      
      if (currentAllocationView === 'all') {
        // All: Savings + Expenses + Trades
        const savingsTotal = calcTotalsFor(savingsData.weekly).savings + calcTotalsFor(savingsData.monthly).savings;
        const expensesTotal = Math.abs(calcTotalsFor(savingsData.weekly).expenses + calcTotalsFor(savingsData.monthly).expenses);
        const tradesTotal = Math.abs(tradesData.reduce((sum, t) => sum + t.pl, 0));
        
        labels = ['Savings', 'Expenses', 'Trades'];
        data = [savingsTotal, expensesTotal, tradesTotal];
        backgroundColor = [
          'rgba(110, 231, 183, 0.8)',
          'rgba(251, 113, 133, 0.8)',
          'rgba(96, 165, 250, 0.8)'
        ];
        
        document.getElementById('allocationTitle').textContent = 'Allocation';
      } else if (currentAllocationView === 'finance') {
        // Finance: Savings + Expenses + Trades (same as All for now)
        const savingsTotal = calcTotalsFor(savingsData.weekly).savings + calcTotalsFor(savingsData.monthly).savings;
        const expensesTotal = Math.abs(calcTotalsFor(savingsData.weekly).expenses + calcTotalsFor(savingsData.monthly).expenses);
        const tradesTotal = Math.abs(tradesData.reduce((sum, t) => sum + t.pl, 0));
        
        labels = ['Savings', 'Expenses', 'Trades'];
        data = [savingsTotal, expensesTotal, tradesTotal];
        backgroundColor = [
          'rgba(110, 231, 183, 0.8)',
          'rgba(251, 113, 133, 0.8)',
          'rgba(96, 165, 250, 0.8)'
        ];
        
        document.getElementById('allocationTitle').textContent = 'Allocation - Finance';
      } else if (currentAllocationView === 'health') {
        // Health: Gym sessions and habits
        const gymSessions = gymData.length;
        const habitsCompleted = habitsData.reduce((sum, h) => sum + h.streak, 0);
        
        labels = ['Gym Sessions', 'Habits'];
        data = [gymSessions, habitsCompleted];
        backgroundColor = [
          'rgba(96, 165, 250, 0.8)',
          'rgba(110, 231, 183, 0.8)'
        ];
        
        document.getElementById('allocationTitle').textContent = 'Allocation - Health';
      }
      
      if (allocationPieChart) allocationPieChart.destroy();
      
      // Only create chart if we have data
      if (data.some(val => val > 0)) {
        allocationPieChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels,
            datasets: [{
              data,
              backgroundColor,
              borderColor: 'rgba(11, 18, 32, 0.5)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    let label = context.label || '';
                    if (label) {
                      label += ': ';
                    }
                    if (currentAllocationView === 'health') {
                      label += context.raw;
                    } else {
                      label += `NLE${context.raw.toFixed(2)}`;
                    }
                    return label;
                  }
                }
              }
            }
          }
        });
      }
    }

    function updateStreaksChart() {
      const ctx = document.getElementById('streaksChart').getContext('2d');
      const longestStreak = habitsData.reduce((max, h) => Math.max(max, h.streak), 0);
      
      if (habitsData.length === 0) {
        if (streaksChart) streaksChart.destroy();
        return;
      }
      
      if (streaksChart) streaksChart.destroy();
      
      streaksChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: habitsData.map(h => h.name),
          datasets: [{
            label: 'Current Streak',
            data: habitsData.map(h => h.streak),
            backgroundColor: 'rgba(96, 165, 250, 0.8)',
            borderColor: 'rgba(96, 165, 250, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { color: 'rgba(148, 163, 184, 0.6)' }
            },
            y: {
              grid: { color: 'rgba(255, 255, 255, 0.03)' },
              ticks: { color: 'rgba(148, 163, 184, 0.6)' },
              suggestedMax: longestStreak > 0 ? longestStreak + 5 : 10
            }
          }
        }
      });
    }

    function updateTradesChart() {
      const ctx = document.getElementById('tradesPerf').getContext('2d');
      
      if (tradesData.length === 0) {
        if (tradesPerfChart) tradesPerfChart.destroy();
        return;
      }
      
      // Group trades by day for the chart
      const tradesByDay = {};
      tradesData.forEach(trade => {
        if (!tradesByDay[trade.date]) tradesByDay[trade.date] = 0;
        tradesByDay[trade.date] += trade.pl;
      });
      
      const dates = Object.keys(tradesByDay).sort();
      const profits = dates.map(date => tradesByDay[date]);
      
      if (tradesPerfChart) tradesPerfChart.destroy();
      
      tradesPerfChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: dates,
          datasets: [{
            label: 'Daily P/L',
            data: profits,
            backgroundColor: profits.map(p => p >= 0 ? 'rgba(110, 231, 183, 0.8)' : 'rgba(251, 113, 133, 0.8)'),
            borderColor: profits.map(p => p >= 0 ? 'rgba(110, 231, 183, 1)' : 'rgba(251, 113, 133, 1)'),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `P/L: $${context.raw.toFixed(2)}`;
                }
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { color: 'rgba(148, 163, 184, 0.6)' }
            },
            y: {
              grid: { color: 'rgba(255, 255, 255, 0.03)' },
              ticks: { 
                color: 'rgba(148, 163, 184, 0.6)',
                callback: function(value) {
                  return `$${value}`;
                }
              }
            }
          }
        }
      });
    }

    function updateGymChart() {
      const ctx = document.getElementById('gymChart').getContext('2d');
      
      if (gymData.length === 0) {
        if (gymChart) gymChart.destroy();
        return;
      }
      
      // Group gym sessions by type
      const types = {};
      gymData.forEach(session => {
        if (!types[session.type]) types[session.type] = 0;
        types[session.type]++;
      });
      
      const typeNames = Object.keys(types);
      const counts = typeNames.map(type => types[type]);
      
      if (gymChart) gymChart.destroy();
      
      gymChart = new Chart(ctx, {
        type: 'polarArea',
        data: {
          labels: typeNames,
          datasets: [{
            label: 'Workouts by Type',
            data: counts,
            backgroundColor: [
              'rgba(110, 231, 183, 0.6)',
              'rgba(96, 165, 250, 0.6)',
              'rgba(251, 113, 133, 0.6)',
              'rgba(148, 163, 184, 0.6)'
            ],
            borderColor: 'rgba(255, 255, 255, 0.1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                color: 'rgba(148, 163, 184, 0.8)'
              }
            }
          }
        }
      });
    }

    function updateHabitsChart() {
      const ctx = document.getElementById('habitWeek').getContext('2d');
      
      if (habitsData.length === 0) {
        if (habitWeekChart) habitWeekChart.destroy();
        return;
      }
      
      // Mock data for weekly habit completion
      const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
      const completion = days.map(() => Math.floor(Math.random() * habitsData.length) + 1);
      
      if (habitWeekChart) habitWeekChart.destroy();
      
      habitWeekChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: days,
          datasets: [{
            label: 'Habits Completed',
            data: completion,
            borderColor: 'rgba(96, 165, 250, 1)',
            backgroundColor: 'rgba(96, 165, 250, 0.1)',
            borderWidth: 2,
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { color: 'rgba(148, 163, 184, 0.6)' }
            },
            y: {
              grid: { color: 'rgba(255, 255, 255, 0.03)' },
              ticks: { color: 'rgba(148, 163, 184, 0.6)' },
              min: 0,
              max: habitsData.length
            }
          }
        }
      });
    }

    /* ---------------------------
       Allocation Tabs
    ----------------------------*/
    document.getElementById('overviewTabAll').addEventListener('click', () => {
      document.querySelectorAll('#overviewTabAll, #overviewTabFinance, #overviewTabHealth').forEach(b => b.classList.remove('active'));
      document.getElementById('overviewTabAll').classList.add('active');
      currentAllocationView = 'all';
      updateAllocationPie();
    });

    document.getElementById('overviewTabFinance').addEventListener('click', () => {
      document.querySelectorAll('#overviewTabAll, #overviewTabFinance, #overviewTabHealth').forEach(b => b.classList.remove('active'));
      document.getElementById('overviewTabFinance').classList.add('active');
      currentAllocationView = 'finance';
      updateAllocationPie();
    });

    document.getElementById('overviewTabHealth').addEventListener('click', () => {
      document.querySelectorAll('#overviewTabAll, #overviewTabFinance, #overviewTabHealth').forEach(b => b.classList.remove('active'));
      document.getElementById('overviewTabHealth').classList.add('active');
      currentAllocationView = 'health';
      updateAllocationPie();
    });

    /* ---------------------------
       Initialization
    ----------------------------*/
    document.addEventListener('DOMContentLoaded', () => {
      // Load all data from localStorage
      loadData();
      
      // Initialize all tabs
      renderTrades();
      renderGym();
      renderTasks();
      renderHabits();
      renderList();
      updateAllSummaries();
      
      // Initialize all charts
      updateAllCharts();
      
      // Set last updated time
      document.getElementById('overviewLastUpdated').textContent = 
        'Last updated: ' + new Date().toLocaleString();
    });

    // Quick add button
    document.getElementById('addQuick').addEventListener('click', () => {
      const options = ['Trade', 'Workout', 'Task', 'Habit', 'Expense', 'Saving'];
      const choice = prompt(`Quick add:\n${options.map((o, i) => `${i+1}. ${o}`).join('\n')}`);
      if (!choice) return;
      
      const index = parseInt(choice) - 1;
      if (isNaN(index) || index < 0 || index >= options.length) return;
      
      const option = options[index];
      switch(option) {
        case 'Trade':
          document.querySelector('[data-tab="trades"]').click();
          setTimeout(() => addTradeBtn.click(), 100);
          break;
        case 'Workout':
          document.querySelector('[data-tab="gym"]').click();
          setTimeout(() => addWorkoutBtn.click(), 100);
          break;
        case 'Task':
          document.querySelector('[data-tab="tasks"]').click();
          setTimeout(() => newTaskInput.focus(), 100);
          break;
        case 'Habit':
          document.querySelector('[data-tab="habits"]').click();
          setTimeout(() => addHabitBtn.click(), 100);
          break;
        case 'Expense':
          document.querySelector('[data-tab="savings"]').click();
          setTimeout(() => {
            typeIn.value = 'expense';
            nameIn.focus();
          }, 100);
          break;
        case 'Saving':
          document.querySelector('[data-tab="savings"]').click();
          setTimeout(() => {
            typeIn.value = 'saving';
            nameIn.focus();
          }, 100);
          break;
      }
    });
  </script>
</body>
</html>